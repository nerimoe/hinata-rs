const S_BOX: [[u8; 256]; 9] = [
    [
        118, 113, 186, 112, 253, 25, 40, 103, 62, 106, 117, 207, 92, 96, 200, 182, 201, 232, 235,
        119, 104, 161, 250, 11, 123, 19, 32, 242, 156, 97, 229, 187, 195, 180, 91, 85, 217, 0, 59,
        163, 159, 192, 243, 21, 202, 126, 61, 110, 93, 66, 87, 38, 34, 82, 218, 80, 233, 240, 10,
        94, 216, 102, 236, 3, 128, 133, 20, 208, 166, 169, 152, 88, 181, 134, 138, 27, 171, 13,
        160, 145, 76, 109, 130, 224, 157, 68, 36, 136, 168, 47, 14, 12, 244, 70, 52, 234, 51, 115,
        131, 206, 179, 99, 100, 48, 69, 23, 148, 165, 193, 226, 212, 55, 213, 89, 120, 211, 86,
        108, 178, 46, 230, 8, 158, 252, 31, 239, 49, 164, 162, 231, 42, 64, 172, 220, 197, 57, 22,
        237, 98, 71, 50, 72, 116, 255, 84, 30, 191, 209, 63, 129, 153, 205, 127, 28, 35, 203, 53,
        29, 41, 248, 83, 95, 15, 56, 223, 111, 185, 173, 247, 58, 39, 254, 246, 135, 45, 107, 177,
        241, 143, 54, 67, 184, 251, 122, 16, 210, 219, 79, 150, 2, 60, 73, 147, 149, 75, 18, 65,
        176, 9, 142, 189, 215, 238, 137, 114, 101, 7, 175, 222, 17, 228, 144, 37, 174, 77, 33, 24,
        78, 188, 227, 146, 90, 183, 170, 81, 199, 132, 221, 141, 190, 6, 204, 105, 26, 74, 245,
        225, 4, 44, 125, 140, 214, 151, 196, 121, 198, 249, 124, 5, 154, 43, 1, 167, 139, 194, 155,
    ],
    [
        49, 121, 138, 165, 133, 189, 63, 67, 238, 123, 149, 162, 205, 146, 175, 202, 17, 109, 18,
        94, 35, 203, 91, 188, 221, 249, 194, 38, 237, 41, 72, 244, 4, 105, 247, 161, 132, 26, 7,
        128, 9, 227, 222, 193, 173, 178, 86, 23, 55, 253, 102, 157, 116, 13, 164, 52, 215, 34, 201,
        152, 236, 80, 115, 99, 107, 213, 27, 135, 127, 15, 192, 5, 88, 218, 36, 185, 110, 154, 44,
        101, 208, 59, 217, 0, 251, 28, 134, 195, 150, 68, 225, 243, 151, 66, 82, 32, 131, 216, 84,
        211, 120, 160, 147, 95, 8, 198, 231, 93, 232, 234, 56, 106, 42, 81, 25, 145, 111, 85, 69,
        89, 11, 241, 233, 126, 48, 136, 252, 137, 103, 51, 37, 183, 21, 214, 2, 64, 250, 191, 206,
        74, 43, 139, 113, 31, 58, 169, 40, 235, 255, 20, 200, 176, 254, 77, 71, 75, 172, 87, 204,
        223, 163, 245, 3, 226, 96, 24, 122, 182, 70, 239, 79, 219, 156, 92, 1, 117, 228, 98, 62,
        97, 148, 143, 16, 158, 184, 54, 187, 112, 114, 129, 119, 104, 118, 212, 155, 47, 246, 179,
        209, 39, 45, 100, 181, 230, 12, 61, 167, 229, 210, 166, 153, 22, 90, 53, 144, 170, 73, 220,
        199, 130, 186, 242, 10, 174, 171, 108, 159, 224, 14, 30, 19, 248, 190, 76, 46, 83, 240, 6,
        78, 29, 57, 177, 168, 125, 140, 124, 142, 65, 33, 50, 196, 60, 180, 141, 207, 197,
    ],
    [
        202, 140, 24, 1, 203, 116, 133, 164, 223, 119, 39, 95, 149, 59, 67, 2, 84, 139, 239, 196,
        120, 64, 167, 75, 4, 229, 156, 52, 30, 18, 161, 134, 218, 38, 192, 65, 124, 226, 222, 179,
        199, 77, 227, 72, 40, 148, 8, 181, 128, 251, 76, 57, 197, 68, 117, 198, 118, 0, 63, 29, 69,
        114, 122, 88, 200, 235, 37, 94, 56, 80, 193, 50, 110, 97, 225, 195, 214, 44, 12, 81, 51,
        141, 166, 31, 74, 237, 175, 173, 58, 17, 174, 131, 215, 210, 45, 36, 172, 25, 3, 121, 102,
        144, 151, 154, 89, 169, 157, 253, 221, 236, 159, 20, 101, 212, 87, 208, 47, 205, 86, 155,
        184, 162, 244, 209, 66, 28, 15, 14, 201, 55, 32, 252, 183, 42, 73, 33, 188, 194, 234, 190,
        23, 13, 146, 220, 213, 109, 105, 43, 143, 230, 90, 35, 22, 103, 137, 54, 83, 204, 233, 145,
        142, 246, 138, 180, 147, 228, 254, 207, 111, 241, 125, 34, 99, 249, 127, 224, 112, 245, 96,
        189, 217, 85, 242, 168, 6, 108, 250, 232, 19, 231, 82, 98, 176, 152, 27, 136, 243, 255,
        171, 10, 49, 191, 185, 113, 240, 186, 93, 182, 187, 129, 104, 153, 5, 132, 150, 48, 46,
        248, 216, 9, 11, 62, 92, 106, 177, 160, 91, 107, 170, 53, 70, 158, 238, 61, 100, 71, 26,
        126, 135, 79, 165, 21, 211, 123, 78, 16, 178, 130, 41, 247, 206, 60, 163, 7, 115, 219,
    ],
    [
        135, 60, 231, 142, 24, 154, 100, 203, 191, 74, 159, 61, 35, 66, 152, 88, 131, 94, 54, 115,
        201, 158, 77, 198, 87, 217, 199, 76, 50, 62, 116, 183, 251, 104, 146, 102, 114, 167, 121,
        80, 243, 149, 93, 136, 164, 148, 14, 51, 30, 139, 168, 218, 237, 17, 125, 126, 171, 21, 69,
        110, 13, 6, 180, 182, 187, 27, 49, 252, 26, 57, 137, 56, 150, 242, 244, 192, 229, 47, 34,
        130, 11, 238, 71, 161, 226, 245, 70, 138, 184, 235, 8, 230, 188, 190, 119, 209, 48, 12, 81,
        84, 185, 16, 205, 145, 3, 250, 193, 254, 189, 31, 124, 156, 79, 127, 55, 7, 41, 249, 101,
        234, 219, 68, 111, 83, 98, 4, 211, 89, 197, 215, 86, 141, 29, 206, 255, 202, 67, 5, 216,
        63, 223, 179, 112, 195, 212, 174, 151, 42, 140, 38, 22, 220, 178, 155, 170, 232, 92, 207,
        106, 52, 90, 117, 53, 157, 194, 43, 10, 123, 224, 165, 15, 166, 186, 204, 143, 248, 82, 96,
        177, 78, 153, 20, 72, 2, 103, 9, 160, 59, 107, 65, 105, 95, 239, 109, 175, 25, 241, 200,
        227, 45, 253, 225, 122, 172, 39, 221, 214, 36, 144, 118, 162, 75, 210, 128, 222, 236, 133,
        120, 108, 44, 196, 228, 33, 181, 64, 58, 1, 147, 169, 85, 134, 18, 233, 37, 23, 113, 32,
        91, 97, 129, 240, 213, 0, 208, 40, 247, 132, 73, 176, 173, 99, 46, 28, 246, 19, 163,
    ],
    [
        211, 237, 224, 13, 235, 175, 101, 63, 62, 0, 86, 47, 3, 142, 204, 115, 176, 127, 174, 131,
        57, 104, 220, 134, 102, 145, 121, 245, 164, 206, 59, 23, 76, 137, 199, 187, 100, 179, 207,
        247, 155, 61, 55, 230, 40, 248, 242, 53, 36, 32, 65, 170, 246, 92, 202, 112, 72, 212, 114,
        18, 119, 41, 194, 161, 239, 241, 167, 48, 147, 205, 51, 227, 73, 20, 85, 118, 180, 143, 7,
        54, 43, 160, 130, 81, 126, 26, 96, 221, 151, 120, 129, 146, 171, 140, 68, 116, 232, 34, 30,
        193, 46, 138, 82, 159, 17, 111, 2, 22, 28, 186, 15, 154, 69, 87, 56, 71, 182, 45, 152, 110,
        222, 60, 84, 35, 133, 191, 251, 150, 178, 1, 213, 77, 195, 8, 94, 91, 139, 107, 70, 99, 93,
        209, 184, 231, 190, 97, 157, 38, 135, 21, 214, 177, 78, 188, 14, 196, 123, 80, 4, 132, 39,
        250, 144, 198, 83, 37, 10, 156, 163, 158, 149, 249, 19, 122, 33, 66, 88, 106, 168, 42, 9,
        234, 197, 216, 105, 141, 29, 252, 254, 201, 24, 200, 136, 58, 27, 189, 128, 219, 215, 173,
        125, 255, 166, 95, 169, 210, 79, 103, 50, 153, 25, 233, 181, 225, 236, 67, 229, 226, 108,
        98, 74, 244, 52, 90, 228, 253, 183, 203, 124, 223, 117, 192, 109, 49, 172, 218, 12, 113, 5,
        148, 6, 165, 240, 31, 208, 185, 64, 11, 89, 238, 243, 217, 44, 16, 162, 75,
    ],
    [
        176, 52, 117, 7, 82, 44, 205, 63, 46, 86, 159, 121, 70, 114, 214, 194, 134, 247, 43, 206,
        124, 6, 160, 123, 167, 41, 3, 166, 40, 32, 112, 200, 127, 150, 80, 95, 148, 136, 67, 147,
        92, 122, 242, 111, 223, 131, 57, 31, 141, 94, 161, 96, 137, 162, 89, 36, 22, 197, 115, 248,
        132, 75, 235, 78, 39, 35, 27, 60, 128, 129, 193, 58, 93, 151, 103, 240, 239, 143, 29, 68,
        156, 83, 76, 125, 252, 229, 158, 174, 234, 99, 198, 106, 178, 227, 213, 66, 250, 109, 155,
        191, 190, 64, 51, 133, 48, 12, 1, 79, 222, 255, 144, 165, 100, 130, 217, 65, 90, 74, 184,
        135, 8, 236, 168, 119, 113, 183, 175, 201, 152, 230, 108, 233, 105, 179, 182, 9, 171, 215,
        71, 202, 172, 11, 189, 61, 196, 85, 23, 142, 28, 185, 104, 116, 54, 253, 16, 98, 254, 0,
        26, 97, 34, 101, 138, 2, 45, 188, 47, 88, 211, 181, 91, 55, 49, 199, 241, 59, 238, 87, 224,
        157, 187, 139, 13, 173, 25, 204, 53, 21, 17, 192, 212, 207, 126, 177, 37, 69, 245, 120,
        210, 110, 169, 118, 149, 10, 145, 154, 153, 208, 107, 56, 163, 102, 33, 4, 244, 24, 20,
        219, 251, 164, 62, 19, 18, 5, 203, 170, 84, 228, 73, 180, 216, 15, 77, 232, 30, 38, 249,
        243, 146, 225, 50, 42, 220, 195, 237, 209, 72, 186, 221, 14, 246, 140, 81, 226, 218, 231,
    ],
    [
        205, 250, 137, 174, 143, 168, 170, 237, 59, 95, 251, 24, 82, 207, 22, 88, 244, 47, 141,
        139, 245, 25, 75, 64, 115, 223, 110, 218, 147, 175, 113, 210, 99, 12, 29, 242, 36, 73, 188,
        38, 138, 198, 238, 177, 100, 136, 54, 246, 77, 86, 196, 33, 144, 132, 160, 117, 45, 150,
        124, 241, 153, 62, 220, 234, 66, 70, 16, 249, 118, 247, 224, 125, 145, 191, 173, 171, 28,
        152, 151, 179, 253, 208, 46, 97, 202, 209, 18, 96, 123, 201, 111, 35, 228, 57, 56, 127,
        148, 52, 76, 61, 159, 197, 83, 193, 204, 106, 58, 172, 101, 214, 131, 68, 230, 90, 181, 31,
        232, 50, 3, 161, 229, 109, 128, 226, 53, 9, 184, 67, 182, 120, 149, 93, 72, 180, 34, 183,
        104, 192, 169, 163, 1, 221, 65, 11, 195, 158, 216, 255, 134, 236, 42, 98, 231, 112, 133,
        167, 185, 155, 103, 107, 165, 63, 189, 235, 199, 212, 200, 187, 79, 225, 30, 119, 254, 162,
        89, 84, 213, 194, 215, 233, 49, 87, 164, 91, 142, 140, 92, 39, 55, 219, 23, 211, 146, 43,
        157, 41, 60, 26, 81, 5, 8, 37, 108, 7, 186, 0, 116, 121, 166, 14, 51, 239, 80, 44, 6, 252,
        10, 21, 206, 176, 69, 222, 48, 17, 240, 190, 2, 135, 19, 85, 248, 20, 71, 13, 217, 114, 15,
        122, 27, 32, 129, 178, 203, 227, 40, 105, 156, 126, 154, 130, 243, 74, 4, 94, 102, 78,
    ],
    [
        196, 73, 210, 192, 40, 228, 59, 162, 54, 180, 216, 255, 96, 238, 71, 160, 36, 253, 150, 50,
        24, 70, 201, 169, 220, 188, 63, 254, 56, 187, 246, 204, 41, 140, 119, 195, 137, 198, 26,
        129, 72, 241, 207, 151, 147, 74, 37, 32, 152, 64, 183, 213, 144, 83, 101, 33, 233, 251, 84,
        203, 177, 114, 197, 173, 48, 110, 161, 10, 166, 159, 124, 91, 43, 226, 185, 138, 105, 230,
        23, 250, 62, 89, 194, 39, 123, 235, 99, 149, 4, 148, 145, 86, 49, 100, 167, 115, 107, 81,
        223, 42, 14, 16, 184, 191, 202, 102, 1, 174, 95, 209, 61, 46, 38, 163, 11, 108, 94, 80,
        248, 126, 175, 193, 47, 222, 66, 217, 57, 103, 31, 22, 88, 186, 247, 168, 116, 221, 87,
        190, 243, 239, 127, 79, 7, 58, 205, 242, 155, 224, 65, 118, 131, 9, 2, 104, 67, 130, 172,
        244, 20, 55, 154, 34, 12, 122, 139, 92, 206, 211, 142, 93, 29, 3, 113, 225, 171, 98, 51,
        179, 121, 82, 77, 8, 27, 227, 6, 199, 178, 165, 158, 53, 60, 156, 68, 15, 153, 75, 170,
        134, 240, 117, 25, 21, 189, 231, 141, 17, 176, 85, 234, 125, 90, 132, 19, 106, 143, 182,
        136, 215, 13, 146, 112, 200, 128, 109, 181, 229, 44, 214, 78, 52, 133, 208, 232, 164, 218,
        135, 69, 157, 249, 245, 76, 219, 236, 5, 120, 30, 111, 237, 0, 28, 18, 252, 35, 45, 212,
        97,
    ],
    [
        111, 167, 20, 185, 172, 8, 145, 117, 81, 186, 69, 164, 140, 74, 33, 104, 235, 148, 137, 63,
        242, 6, 64, 134, 188, 194, 244, 57, 138, 255, 168, 178, 62, 50, 131, 39, 17, 166, 197, 5,
        151, 237, 92, 124, 118, 198, 13, 221, 191, 207, 67, 60, 56, 28, 71, 75, 112, 223, 21, 212,
        214, 72, 107, 193, 211, 15, 0, 41, 252, 95, 61, 70, 154, 86, 55, 34, 91, 2, 109, 239, 176,
        108, 102, 35, 226, 14, 157, 190, 216, 128, 49, 93, 1, 147, 196, 23, 153, 54, 208, 175, 87,
        165, 143, 139, 120, 225, 187, 114, 224, 66, 218, 48, 12, 77, 217, 119, 247, 189, 11, 141,
        3, 174, 238, 231, 47, 127, 98, 51, 97, 96, 156, 135, 254, 142, 103, 245, 209, 184, 85, 29,
        220, 248, 76, 45, 246, 177, 162, 230, 88, 40, 65, 58, 182, 123, 101, 46, 37, 129, 43, 159,
        78, 240, 253, 150, 183, 90, 73, 116, 158, 161, 243, 222, 36, 122, 27, 106, 113, 179, 44,
        155, 200, 25, 215, 115, 83, 126, 236, 80, 204, 169, 26, 202, 205, 100, 132, 53, 16, 9, 152,
        181, 84, 82, 136, 228, 125, 160, 249, 206, 199, 42, 31, 22, 38, 130, 195, 10, 203, 201,
        173, 68, 180, 146, 210, 219, 133, 32, 94, 171, 192, 4, 213, 227, 232, 234, 170, 110, 7,
        163, 24, 30, 18, 52, 121, 229, 79, 89, 99, 59, 241, 19, 251, 144, 149, 105, 233, 250,
    ],
];

const S_BOX_KEY: [u8; 9] = [217, 50, 139, 241, 121, 110, 212, 144, 172];
const HASH_ADD: usize = 5;

const N_TABLES: usize = S_BOX.len() - 1;

fn rotate_right(data: &mut [u8], n_bytes: usize, n_bits: usize) {
    if data.len() < n_bytes || n_bytes == 0 {
        return;
    }

    let mut prior = data[n_bytes - 1];
    for i in 0..n_bytes {
        let current = data[i];
        let mask = (1 << n_bits) - 1;
        data[i] = (current >> n_bits) | ((prior & mask) << (8 - n_bits));
        prior = current;
    }
}

fn rotate_left(data: &mut [u8], n_bytes: usize, n_bits: usize) {
    if data.len() < n_bytes || n_bytes == 0 {
        return;
    }

    let mut prior = data[0];
    for i in (0..n_bytes).rev() {
        let current = data[i];
        let mask = (1 << (8 - n_bits)) - 1;
        data[i] = ((current & mask) << n_bits) | (prior >> (8 - n_bits));
        prior = current;
    }
}

pub fn spad0_encrypt(input: &[u8]) -> Result<Vec<u8>, String> {
    let mut spad = input.to_vec();

    if spad.len() < 16 {
        return Err("Input data too short for spad0_encrypt".to_string());
    }

    let count = (spad[15] >> 4) as usize + 7;
    let mut table = spad[15] as usize;

    for _ in 0..count {
        for i in 0..15 {
            spad[i] = S_BOX[table % N_TABLES][spad[i] as usize];
        }
        rotate_left(&mut spad, 15, 5);
        table += HASH_ADD;
    }

    Ok(spad.iter().map(|&b| S_BOX[N_TABLES][b as usize]).collect())
}

pub fn spad0_decrypt(input: &[u8]) -> Result<Vec<u8>, String> {
    let mut s_box_inv = [[0u8; 256]; 9];

    for i in 0..9 {
        for i2 in 0..256 {
            // Dart: var i3 = (sBox[i][i2] ^ sBoxKey[i]);
            let i3 = (S_BOX[i][i2] ^ S_BOX_KEY[i]) as usize;
            s_box_inv[i][i3] = i2 as u8;
        }
    }

    let mut spad: Vec<u8> = input.iter()
        .map(|&b| s_box_inv[N_TABLES][b as usize])
        .collect();

    if spad.len() < 16 {
        return Err("Input data too short for spad0_decrypt".to_string());
    }

    let count = (spad[15] >> 4) as usize + 7;
    let mut table = spad[15] as usize + HASH_ADD * count;

    for _ in 0..count {
        table -= HASH_ADD;
        rotate_right(&mut spad, 15, 5);
        for i in 0..15 {
            spad[i] = s_box_inv[table % N_TABLES][spad[i] as usize];
        }
    }

    Ok(spad)
}